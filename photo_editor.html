<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Editor de Fotos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #a855f7;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #a855f7;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">‚ú® Editor de Fotos</h1>
            <p class="text-purple-200">Retoca y mejora tus selfies (100% Gratis)</p>
            <button onclick="window.location.href='selfiecam.html'" class="mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full font-bold hover:shadow-lg transition-all">
                ‚¨ÖÔ∏è Volver a la C√°mara
            </button>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 mb-6 text-center">
            <div class="text-6xl mb-4">üì∏</div>
            <h2 class="text-2xl text-white font-bold mb-4">Carga tu foto</h2>
            <label class="inline-block bg-gradient-to-r from-pink-500 to-purple-500 text-white px-8 py-4 rounded-full font-bold cursor-pointer hover:shadow-lg transition-all">
                üñºÔ∏è Seleccionar Foto
                <input type="file" accept="image/*" id="imageInput" class="hidden">
            </label>
            <p class="text-purple-200 mt-4 text-sm">Acepta JPG, PNG, HEIC</p>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="text-center text-white">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mb-4"></div>
                <p class="text-xl font-bold">Procesando imagen...</p>
            </div>
        </div>

        <!-- Editor Section -->
        <div id="editorSection" class="space-y-6 hidden">
            <!-- Comparaci√≥n Antes/Despu√©s -->
            <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">üëÅÔ∏è Comparaci√≥n Antes/Despu√©s</h3>
                    <button id="closeBtn" class="bg-red-500 text-white px-4 py-2 rounded-full font-bold hover:bg-red-600 transition-all">
                        ‚úï Cerrar
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <!-- Canvas Original -->
                    <div>
                        <p class="text-white text-sm font-bold mb-2">üì∑ Original</p>
                        <div class="rounded-2xl overflow-hidden shadow-2xl bg-black/50">
                            <canvas id="originalCanvas" class="w-full h-auto"></canvas>
                        </div>
                    </div>
                    
                    <!-- Canvas Retocada -->
                    <div>
                        <p class="text-white text-sm font-bold mb-2">‚ú® Retocada</p>
                        <div class="rounded-2xl overflow-hidden shadow-2xl bg-black/50">
                            <canvas id="enhancedCanvas" class="w-full h-auto"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controles de Ajuste -->
            <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6">
                <h4 class="text-white font-bold mb-4">üé® Ajustes de Imagen</h4>
                
                <div class="space-y-4">
                    <!-- Brillo -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="text-white text-sm font-semibold flex justify-between mb-2">
                            <span>‚òÄÔ∏è Brillo</span>
                            <span id="brightnessValue">0%</span>
                        </label>
                        <input type="range" min="-100" max="100" value="0" id="brightnessSlider" class="w-full">
                        <p class="text-purple-200 text-xs mt-1">Ilumina u oscurece la imagen</p>
                    </div>

                    <!-- Contraste -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="text-white text-sm font-semibold flex justify-between mb-2">
                            <span>üé≠ Contraste</span>
                            <span id="contrastValue">0%</span>
                        </label>
                        <input type="range" min="-100" max="100" value="0" id="contrastSlider" class="w-full">
                        <p class="text-purple-200 text-xs mt-1">Aumenta la diferencia entre luces y sombras</p>
                    </div>

                    <!-- Saturaci√≥n -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="text-white text-sm font-semibold flex justify-between mb-2">
                            <span>üåà Saturaci√≥n</span>
                            <span id="saturationValue">0%</span>
                        </label>
                        <input type="range" min="-100" max="100" value="0" id="saturationSlider" class="w-full">
                        <p class="text-purple-200 text-xs mt-1">Intensifica o reduce los colores</p>
                    </div>

                    <!-- Nitidez -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="text-white text-sm font-semibold flex justify-between mb-2">
                            <span>üîç Nitidez</span>
                            <span id="sharpnessValue">0</span>
                        </label>
                        <input type="range" min="0" max="2" step="0.1" value="0" id="sharpnessSlider" class="w-full">
                        <p class="text-purple-200 text-xs mt-1">Define mejor los bordes y detalles</p>
                    </div>

                    <!-- Suavizado de Piel -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="text-white text-sm font-semibold flex justify-between mb-2">
                            <span>‚ú® Suavizado de Piel</span>
                            <span id="smoothValue">0</span>
                        </label>
                        <input type="range" min="0" max="5" step="0.5" value="0" id="smoothSlider" class="w-full">
                        <p class="text-purple-200 text-xs mt-1">Reduce imperfecciones y arrugas</p>
                    </div>

                    <!-- Temperatura de Color -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="text-white text-sm font-semibold flex justify-between mb-2">
                            <span>üå°Ô∏è Temperatura</span>
                            <span id="temperatureValue">0</span>
                        </label>
                        <input type="range" min="-50" max="50" value="0" id="temperatureSlider" class="w-full">
                        <p class="text-purple-200 text-xs mt-1">C√°lido (amarillo) ‚Üê ‚Üí Fr√≠o (azul)</p>
                    </div>
                </div>

                <!-- Botones de Presets -->
                <div class="mt-6">
                    <h5 class="text-white font-bold mb-3">‚ö° Mejoras R√°pidas</h5>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <button id="autoEnhanceBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                            ‚ú® Auto Mejorar
                        </button>
                        <button id="portraitBtn" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                            üë§ Retrato
                        </button>
                        <button id="vibrantBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                            üé® Vibrante
                        </button>
                        <button id="bwBtn" class="bg-gradient-to-r from-gray-500 to-gray-700 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                            ‚ö´ Blanco/Negro
                        </button>
                        <button id="warmBtn" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                            üî• C√°lido
                        </button>
                        <button id="resetBtn" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                            üîÑ Resetear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botones de Guardar -->
            <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6">
                <h4 class="text-white font-bold mb-4">üíæ Guardar Fotos</h4>
                <div class="grid md:grid-cols-3 gap-3">
                    <button id="saveOriginalBtn" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-6 py-4 rounded-full font-bold hover:shadow-lg transition-all">
                        üíæ Guardar Original en Cloudinary
                    </button>
                    <button id="saveEnhancedBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-4 rounded-full font-bold hover:shadow-lg transition-all">
                        ‚ú® Guardar Retocada en Cloudinary
                    </button>
                    <button id="downloadBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-4 rounded-full font-bold hover:shadow-lg transition-all">
                        üì• Descargar Retocada
                    </button>
                </div>
                <p class="text-purple-200 text-sm mt-4 text-center">Las fotos se guardan autom√°ticamente en tu galer√≠a</p>
            </div>

            <!-- Tips -->
            <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6">
                <h4 class="text-white font-bold mb-3">üí° Consejos</h4>
                <ul class="text-purple-200 text-sm space-y-2">
                    <li>‚Ä¢ Usa <strong>"Auto Mejorar"</strong> para ajuste autom√°tico de brillo y contraste</li>
                    <li>‚Ä¢ <strong>"Retrato"</strong> suaviza la piel y mejora el tono</li>
                    <li>‚Ä¢ El <strong>Suavizado de Piel</strong> es perfecto para selfies</li>
                    <li>‚Ä¢ Ajusta la <strong>Temperatura</strong> para corregir fotos amarillentas o azuladas</li>
                    <li>‚Ä¢ Todo el procesamiento es local (gratis) - no usa APIs externas</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE CLOUDINARY
        const CLOUDINARY_CLOUD_NAME = 'dukqtp9ww';
        const CLOUDINARY_UPLOAD_PRESET = 'graduacion';
        const CLOUDINARY_FOLDER = 'graduacion';

        // Canvas y contextos
        const originalCanvas = document.getElementById('originalCanvas');
        const enhancedCanvas = document.getElementById('enhancedCanvas');
        const originalCtx = originalCanvas.getContext('2d');
        const enhancedCtx = enhancedCanvas.getContext('2d');

        // Variables globales
        let originalImage = null;
        let originalImageData = null;

        // Ajustes actuales
        let adjustments = {
            brightness: 0,
            contrast: 0,
            saturation: 0,
            sharpness: 0,
            smooth: 0,
            temperature: 0
        };

        // Cargar imagen
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        originalImage = img;
                        initializeCanvases(img);
                        document.getElementById('uploadSection').classList.add('hidden');
                        document.getElementById('editorSection').classList.remove('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Inicializar canvas con la imagen
        function initializeCanvases(img) {
            const maxWidth = 600;
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }

            originalCanvas.width = enhancedCanvas.width = width;
            originalCanvas.height = enhancedCanvas.height = height;

            // Dibujar original
            originalCtx.drawImage(img, 0, 0, width, height);
            
            // Guardar datos originales
            originalImageData = originalCtx.getImageData(0, 0, width, height);
            
            // Aplicar mejoras
            applyEnhancements();
        }

        // Aplicar todas las mejoras
        function applyEnhancements() {
            if (!originalImageData) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');

            setTimeout(() => {
                // Copiar datos originales
                const imageData = new ImageData(
                    new Uint8ClampedArray(originalImageData.data),
                    originalImageData.width,
                    originalImageData.height
                );

                // Aplicar ajustes en orden
                applyBrightness(imageData, adjustments.brightness);
                applyContrast(imageData, adjustments.contrast);
                applySaturation(imageData, adjustments.saturation);
                applyTemperature(imageData, adjustments.temperature);
                
                // Dibujar en canvas
                enhancedCtx.putImageData(imageData, 0, 0);

                // Aplicar suavizado si est√° activado
                if (adjustments.smooth > 0) {
                    enhancedCtx.filter = `blur(${adjustments.smooth * 0.3}px)`;
                    enhancedCtx.drawImage(enhancedCanvas, 0, 0);
                    enhancedCtx.filter = 'none';
                }

                // Aplicar nitidez si est√° activado
                if (adjustments.sharpness > 0) {
                    applySharpness(adjustments.sharpness);
                }

                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 50);
        }

        // Ajustar brillo
        function applyBrightness(imageData, value) {
            const data = imageData.data;
            const adjustment = value * 2.55; // Convertir a rango 0-255

            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, data[i] + adjustment));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + adjustment));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + adjustment));
            }
        }

        // Ajustar contraste
        function applyContrast(imageData, value) {
            const data = imageData.data;
            const factor = (259 * (value + 255)) / (255 * (259 - value));

            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));
                data[i + 1] = Math.max(0, Math.min(255, factor * (data[i + 1] - 128) + 128));
                data[i + 2] = Math.max(0, Math.min(255, factor * (data[i + 2] - 128) + 128));
            }
        }

        // Ajustar saturaci√≥n
        function applySaturation(imageData, value) {
            const data = imageData.data;
            const adjustment = value / 100;

            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.2989 * data[i] + 0.5870 * data[i + 1] + 0.1140 * data[i + 2];
                
                data[i] = Math.max(0, Math.min(255, gray + (data[i] - gray) * (1 + adjustment)));
                data[i + 1] = Math.max(0, Math.min(255, gray + (data[i + 1] - gray) * (1 + adjustment)));
                data[i + 2] = Math.max(0, Math.min(255, gray + (data[i + 2] - gray) * (1 + adjustment)));
            }
        }

        // Ajustar temperatura de color
        function applyTemperature(imageData, value) {
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                if (value > 0) {
                    // C√°lido (m√°s amarillo/rojo)
                    data[i] = Math.min(255, data[i] + value); // Rojo
                    data[i + 1] = Math.min(255, data[i + 1] + value * 0.5); // Verde
                } else {
                    // Fr√≠o (m√°s azul)
                    data[i + 2] = Math.min(255, data[i + 2] - value); // Azul
                }
            }
        }

        // Aplicar nitidez (sharpen)
        function applySharpness(amount) {
            const imageData = enhancedCtx.getImageData(0, 0, enhancedCanvas.width, enhancedCanvas.height);
            const data = imageData.data;
            const w = imageData.width;
            const h = imageData.height;

            // Matriz de convoluci√≥n para sharpen
            const kernel = [
                0, -amount, 0,
                -amount, 1 + 4 * amount, -amount,
                0, -amount, 0
            ];

            const tempData = new Uint8ClampedArray(data);

            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        const idx = (y * w + x) * 4 + c;
                        
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const pixelIdx = ((y + ky) * w + (x + kx)) * 4 + c;
                                const kernelIdx = (ky + 1) * 3 + (kx + 1);
                                sum += tempData[pixelIdx] * kernel[kernelIdx];
                            }
                        }
                        
                        data[idx] = Math.max(0, Math.min(255, sum));
                    }
                }
            }

            enhancedCtx.putImageData(imageData, 0, 0);
        }

        // Event listeners para sliders
        document.getElementById('brightnessSlider').addEventListener('input', (e) => {
            adjustments.brightness = Number(e.target.value);
            document.getElementById('brightnessValue').textContent = adjustments.brightness + '%';
            applyEnhancements();
        });

        document.getElementById('contrastSlider').addEventListener('input', (e) => {
            adjustments.contrast = Number(e.target.value);
            document.getElementById('contrastValue').textContent = adjustments.contrast + '%';
            applyEnhancements();
        });

        document.getElementById('saturationSlider').addEventListener('input', (e) => {
            adjustments.saturation = Number(e.target.value);
            document.getElementById('saturationValue').textContent = adjustments.saturation + '%';
            applyEnhancements();
        });

        document.getElementById('sharpnessSlider').addEventListener('input', (e) => {
            adjustments.sharpness = Number(e.target.value);
            document.getElementById('sharpnessValue').textContent = adjustments.sharpness;
            applyEnhancements();
        });

        document.getElementById('smoothSlider').addEventListener('input', (e) => {
            adjustments.smooth = Number(e.target.value);
            document.getElementById('smoothValue').textContent = adjustments.smooth;
            applyEnhancements();
        });

        document.getElementById('temperatureSlider').addEventListener('input', (e) => {
            adjustments.temperature = Number(e.target.value);
            document.getElementById('temperatureValue').textContent = adjustments.temperature;
            applyEnhancements();
        });

        // Presets
        document.getElementById('autoEnhanceBtn').addEventListener('click', () => {
            adjustments.brightness = 15;
            adjustments.contrast = 20;
            adjustments.saturation = 10;
            updateSliders();
            applyEnhancements();
        });

        document.getElementById('portraitBtn').addEventListener('click', () => {
            adjustments.brightness = 10;
            adjustments.contrast = 15;
            adjustments.smooth = 2;
            adjustments.temperature = 5;
            updateSliders();
            applyEnhancements();
        });

        document.getElementById('vibrantBtn').addEventListener('click', () => {
            adjustments.saturation = 40;
            adjustments.contrast = 15;
            updateSliders();
            applyEnhancements();
        });

        document.getElementById('bwBtn').addEventListener('click', () => {
            adjustments.saturation = -100;
            adjustments.contrast = 25;
            updateSliders();
            applyEnhancements();
        });

        document.getElementById('warmBtn').addEventListener('click', () => {
            adjustments.temperature = 30;
            adjustments.saturation = 15;
            updateSliders();
            applyEnhancements();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            adjustments = {
                brightness: 0,
                contrast: 0,
                saturation: 0,
                sharpness: 0,
                smooth: 0,
                temperature: 0
            };
            updateSliders();
            applyEnhancements();
        });

        function updateSliders() {
            document.getElementById('brightnessSlider').value = adjustments.brightness;
            document.getElementById('contrastSlider').value = adjustments.contrast;
            document.getElementById('saturationSlider').value = adjustments.saturation;
            document.getElementById('sharpnessSlider').value = adjustments.sharpness;
            document.getElementById('smoothSlider').value = adjustments.smooth;
            document.getElementById('temperatureSlider').value = adjustments.temperature;

            document.getElementById('brightnessValue').textContent = adjustments.brightness + '%';
            document.getElementById('contrastValue').textContent = adjustments.contrast + '%';
            document.getElementById('saturationValue').textContent = adjustments.saturation + '%';
            document.getElementById('sharpnessValue').textContent = adjustments.sharpness;
            document.getElementById('smoothValue').textContent = adjustments.smooth;
            document.getElementById('temperatureValue').textContent = adjustments.temperature;
        }

        // Subir a Cloudinary
        async function uploadToCloudinary(canvas, filename) {
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            
            const formData = new FormData();
            formData.append('file', blob, filename);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', CLOUDINARY_FOLDER);

            const response = await fetch(
                `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                { method: 'POST', body: formData }
            );

            return await response.json();
        }

        // Guardar en localStorage
        function saveToLocalStorage(photoData) {
            const savedPhotos = localStorage.getItem('tito_photos');
            let photos = savedPhotos ? JSON.parse(savedPhotos) : [];
            photos.unshift(photoData);
            if (photos.length > 100) photos = photos.slice(0, 100);
            localStorage.setItem('tito_photos', JSON.stringify(photos));
        }

        // Guardar original
        document.getElementById('saveOriginalBtn').addEventListener('click', async () => {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const data = await uploadToCloudinary(originalCanvas, 'original.png');
                saveToLocalStorage({
                    public_id: data.public_id,
                    url: data.secure_url,
                    created_at: new Date().toISOString(),
                    format: 'png',
                    type: 'original'
                });
                alert('‚úÖ Foto original guardada en Cloudinary y en la galer√≠a!');
            } catch (error) {
                console.error(error);
                alert('Error al guardar la foto');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        });

        // Guardar retocada
        document.getElementById('saveEnhancedBtn').addEventListener('click', async () => {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const data = await uploadToCloudinary(enhancedCanvas, 'enhanced.png');
                saveToLocalStorage({
                    public_id: data.public_id,
                    url: data.secure_url,
                    created_at: new Date().toISOString(),
                    format: 'png',
                    type: 'enhanced'
                });
                alert('‚úÖ Foto retocada guardada en Cloudinary y en la galer√≠a!');
            } catch (error) {
                console.error(error);
                alert('Error al guardar la foto');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        });

        // Descargar
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `foto-retocada-${Date.now()}.png`;
            link.href = enhancedCanvas.toDataURL('image/png');
            link.click();
        });

        // Cerrar
        document.getElementById('closeBtn').addEventListener('click', () => {
            originalImage = null;
            originalImageData = null;
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('editorSection').classList.add('hidden');
            document.getElementById('imageInput').value = '';
        });
    </script>
</body>
</html>